generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url = env("DATABASE_URL")
}

//////////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////////

model User {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  name         String?
  email        String     @unique
  password     String?
  role         String     @default("user")

  resetToken   String?
  resetExpires DateTime?

  orders       Order[]
  wishlist     Wishlist[]
  cartItems    CartItem[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

//////////////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////////////

model Category {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  slug          String         @unique
  image         String?
  subCategories SubCategory[]
  products      Product[]

  createdAt     DateTime       @default(now())
}

model SubCategory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String    @unique

  categoryId  String    @db.ObjectId
  category    Category @relation(fields: [categoryId], references: [id])

  products    Product[]

  createdAt   DateTime  @default(now())

  @@index([categoryId])
}

//////////////////////////////////////////////////////////
// PRODUCT
//////////////////////////////////////////////////////////

model Product {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  description    String
  price          Int
  originalPrice  Int?

  brand          String?

  categoryId     String?       @db.ObjectId
  category       Category?     @relation(fields: [categoryId], references: [id])

  subCategoryId  String?       @db.ObjectId
  subCategory    SubCategory?  @relation(fields: [subCategoryId], references: [id])

  isFeatured     Boolean       @default(false)
  images         String[]
  thumbnail      String

  sizes          String[]
  colors         String[]

  stock          Int

  rating         Float?
  totalReviews   Int?

  wishlist       Wishlist[]
  cartItems      CartItem[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([categoryId])
  @@index([subCategoryId])
}

//////////////////////////////////////////////////////////
// WISHLIST
//////////////////////////////////////////////////////////

model Wishlist {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])

  productId  String   @db.ObjectId
  product    Product  @relation(fields: [productId], references: [id])

  createdAt  DateTime @default(now())

  @@unique([userId, productId])
}

//////////////////////////////////////////////////////////
// CART ITEM
//////////////////////////////////////////////////////////

model CartItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])

  productId  String   @db.ObjectId
  product    Product  @relation(fields: [productId], references: [id])

  quantity   Int      @default(1)
  size       String?
  color      String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, productId, size, color])
}

//////////////////////////////////////////////////////////
// ORDER
//////////////////////////////////////////////////////////

model Order {
  id                    String       @id @default(auto()) @map("_id") @db.ObjectId

  userId                String?      @db.ObjectId
  user                  User?        @relation(fields: [userId], references: [id])

  email                 String
  amount                Int
  currency              String       @default("npr")
  status                String       @default("pending")
  paymentMethod         String?      @default("card")

  stripeCheckoutSession String?      @unique
  stripePaymentIntentId String?      @unique
  esewaRefId            String?      @unique
  khaltiToken           String?      @unique

  items                 OrderItem[]

  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@index([userId])
  @@index([email])
  @@index([status])
}

model OrderItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId

  orderId     String   @db.ObjectId
  order       Order    @relation(fields: [orderId], references: [id])

  productId   String   @db.ObjectId

  name        String
  price       Int
  thumbnail   String
  size        String?
  color       String?
  quantity    Int

  @@index([orderId])
  @@index([productId])
}

//////////////////////////////////////////////////////////
// CONTACT
//////////////////////////////////////////////////////////

model Contact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String
  message   String
  createdAt DateTime @default(now())
}
